# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

schedules:
- cron: "0 0 * * 0"
  displayName: Weekly Sunday build
  branches:
    include:
    - master
  always: true

# Windows Build Job
jobs:
- job: WindowsBuild
  pool:
    vmImage: 'vs2017-win2016'

  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    path: UefiPkg

  - powershell: |
      $PYTHON2_PATH = ((Get-Item C:\hostedtoolcache\windows\Python\2*\x64) | Sort-Object -Descending)[0].FullName
      echo "##vso[task.setvariable variable=PYTHON2]$PYTHON2_PATH"

    displayName: "Detect Python2 installation path"

  - script: |
      cd..
      git clone https://github.com/tianocore/edk2 -b UDK2018
      xcopy /e /y UefiPkg edk2\UefiPkg\
      cd edk2
      set PYTHON_HOME=$(PYTHON2)
      set NASM_PREFIX=%cd%\UefiPkg\Tools\Nasm\
      edksetup.bat rebuild && build -a IA32 -a X64 -b RELEASE -t VS2017 -p UefiPkg\UefiPkg.dsc
    displayName: 'Run a Windows build script'

  - script:
      xcopy /y ..\edk2\Build\UefiPkg\RELEASE_VS2017\X64\*.efi $(Build.ArtifactStagingDirectory)\
    displayName: 'Copy build files to Artifact'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: UefiPkgBinary_Win

# Linux Build Job
- job: LinuxBuild
  pool:
    vmImage: 'ubuntu-16.04'

  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    path: UefiPkg

  - script: |
      chmod +x build.sh
      ./build.sh
    displayName: 'Run a Linux build script'

  - script: |
      cp edk2/Build/UefiPkg/RELEASE_GCC5/X64/*.efi $(Build.ArtifactStagingDirectory)/
    displayName: 'Copy build files to Artifact'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: UefiPkgBinary_Linux
