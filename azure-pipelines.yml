# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

# Windows Build Job
jobs:
- job: WindowsBuild
  pool:
    vmImage: 'vs2017-win2016'

  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    path: UefiPkg

  - script: |
      cd..
      git clone https://github.com/tianocore/edk2 -b UDK2018
      xcopy /e /y UefiPkg edk2\UefiPkg\
      cd edk2
      set PYTHON_HOME=C:\Python27amd64
      set NASM_PREFIX=%cd%\UefiPkg\Tools\Nasm\
      edksetup.bat rebuild && build -p UefiPkg\UefiPkg.dsc -a X64 -t VS2017 -b RELEASE
    displayName: 'Run a Windows build script'

  - script:
      xcopy /y ..\edk2\Build\UefiPkg\RELEASE_VS2017\X64\*.efi Build\
    displayName: 'Copy build files to SourcesDirectory'

  - task: CopyFiles@2
    inputs:
      contents: 'Build\*.efi'
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: UefiPkgBinary_Win

# Linux Build Job
- job: LinuxBuild
  pool:
    vmImage: 'ubuntu-16.04'

  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    path: UefiPkg

  - script: |
      chmod +x build.sh
      ./build.sh
    displayName: 'Run a Linux build script'

  - script: |
      cp edk2/Build/UefiPkg/RELEASE_GCC5/X64/*.efi $(Build.ArtifactStagingDirectory)/
    displayName: 'Copy build files to Artifact'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: $(Build.ArtifactStagingDirectory)
      artifactName: UefiPkgBinary_Linux
